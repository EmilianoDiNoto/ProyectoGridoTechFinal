<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inventario Actual</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="styleinventaio.css" />
   <!-- Importa Chart.js -->
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
 

<body>
  <header>
    
    <h1>Inventario Actual</h1>
  </header>
  <main>
    <section class="search-section">
      <input type="text" id="searchInput" placeholder="Buscar en el inventario..." onkeyup="filterTable()" />
    </section>
    <section class="table-section">
      <table id="inventoryTable">
        <thead>
          <tr>
            <th>Material</th>
            <th>Stock Inicial</th>
            <th>Stock Final</th>
            <th>Fecha de Inventario</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <!-- Aquí se agregarán las filas de la tabla -->
        </tbody>
      </table>
    </section>
    
    <!-- Botón para añadir nuevo artículo -->
    <section class="add-section">
      <button id="addArticleBtn" onclick="openAddModal()">➕ Añadir Nuevo Inventario</button>
    </section>

    <!-- Modal para añadir nuevo artículo -->
    <div id="addModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="closeAddModal()">&times;</span>
        <h2>Añadir Nuevo Artículo</h2>
        <form id="addForm" onsubmit="addRecord(event)">
          <label for="itemSelect">Material:</label>
          <select id="itemSelect" name="itemSelect" required>
            <option value="" disabled selected>Selecciona un material</option>
            <!-- Las opciones se llenarán dinámicamente -->
          </select>

          <label for="initialQuantity">Stock Inicial:</label>
          <input type="number" id="initialQuantity" name="initialQuantity" required />

          <label for="finalQuantity">Stock Final:</label>
          <input type="number" id="finalQuantity" name="finalQuantity" required />

          <button type="submit">Añadir Inventario</button>
        </form>
      </div>
    </div>

    <section class="generate-section">
      <button id="generateImageBtn" onclick="generateImage()">
        Generar Imagen del Inventario
      </button>
    </section>
  </main>
     <!-- Sección para el gráfico -->
     <section class="chart-section">
      <h2>Material más inventariado</h2>
      <canvas id="inventoryChart" width="400" height="200"></canvas>
    </section>
  </main>

  <script src="script.js"></script>
  <script>
    // Función para listar el inventario y generar el gráfico
    function Get() {
      fetch("http://localhost:63152/api/Inventory")
        .then((response) => response.json())
        .then((data) => {
          const tbody = document.querySelector(`tbody`);
          tbody.innerHTML = ""; // Limpiar la tabla antes de agregar filas

          // Contador de ocurrencias de cada material
          const materialCounts = {};

          data.forEach((o) => {
            let _tr = `<tr>
                          <td>${o.Material}</td>
                          <td>${o.Stock_Inicial}</td>
                          <td>${o.Stock_Final}</td>
                          <td>${o.Fecha_de_Inventario}</td>
                          <td><button onclick="editMaterial('${o.InventoryID}','${o.Material}', '${o.Stock_Inicial}', ${o.Stock_Final}, '${o.Fecha_de_Inventario}')">Modificar</button></td>
                      </tr>`;
            tbody.innerHTML += _tr;

            // Contar ocurrencias de cada material
            if (materialCounts[o.Material]) {
              materialCounts[o.Material]++;
            } else {
              materialCounts[o.Material] = 1;
            }
          });

          // Actualizar el gráfico con los materiales más inventariados
          updateChart(materialCounts);
        });
    }
    Get();

    // Función para actualizar el gráfico de barras
    function updateChart(materialCounts) {
      const ctx = document.getElementById("inventoryChart").getContext("2d");

      const labels = Object.keys(materialCounts);
      const data = Object.values(materialCounts);

      // Destruir el gráfico previo si existe
      if (window.inventoryChart) {
        window.inventoryChart.destroy();
      }

      // Crear nuevo gráfico de barras
      window.inventoryChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Veces inventariado",
            data: data,
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>

  <!-- Modal para modificar -->
  <div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>Modificar Inventario</h2>
      <form id="editForm" onsubmit="updateRecord(event)">
        <input type="hidden" id="editId" />

        <label for="editItemName">Material:</label>
        <input type="text" id="editItemName" required />

        <label for="editInitialQuantity">Stock Inicial:</label>
        <input type="number" id="editInitialQuantity" required />

        <label for="editFinalQuantity">Stock Final:</label>
        <input type="number" id="editFinalQuantity" required />

        <button type="submit">Guardar Cambios</button>
      </form>
    </div>
  </div>

  
  <script src="script.js"></script>
  <script>
    //Funcion listar
    function Get() {
      fetch("http://localhost:63152/api/Inventory")
        .then((response) => response.json())
        .then((data) => {
          const tbody = document.querySelector(`tbody`);
          tbody.innerHTML = ""; // Limpiar la tabla antes de agregar filas

          data.forEach((o) => {
            let _tr = `<tr>
                          <td>${o.Material}</td>
                          <td>${o.Stock_Inicial}</td>
                          <td>${o.Stock_Final}</td>
                          <td>${o.Fecha_de_Inventario}</td>
                          <td><button onclick="editMaterial('${o.InventoryID}','${o.Material}', '${o.Stock_Inicial}', ${o.Stock_Final}, '${o.Fecha_de_Inventario}')">Modificar</button></td>
                      </tr>`;
            tbody.innerHTML += _tr;
          });

          // Llenar el desplegable de materiales
          const itemSelect = document.getElementById("itemSelect");
          itemSelect.innerHTML = `<option value="" disabled selected>Selecciona un material</option>`; // Reiniciar el desplegable
          data.forEach(item => {
            itemSelect.innerHTML += `<option value="${item.Material}">${item.Material}</option>`;
          });
        });
    }
    Get();

    // Funciones para añadir un nuevo artículo
    function openAddModal() {
      document.getElementById("addModal").style.display = "block";
    }

    function closeAddModal() {
      document.getElementById("addModal").style.display = "none";
    }

    function addRecord(event) {
      event.preventDefault();

      // Captura los valores del formulario
      const material = document.getElementById("itemSelect").value;
      const initialStock = document.getElementById("initialQuantity").value;
      const finalStock = document.getElementById("finalQuantity").value;
      const date = new Date().toISOString(); // Fecha actual

      // Crea el objeto con los datos
      const newInventoryItem = {
        Material: material,
        InitialStock: parseInt(initialStock),
        FinalStock: parseInt(finalStock),
        Date: date,
        BatchNumber: material // Usa el nombre del material como número de lote, si aplica
      };

      // Realiza la solicitud POST a la API
      fetch("http://localhost:63152/api/Inventory", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(newInventoryItem)
      })
        .then(response => {
          if (response.ok) {
            alert("Artículo añadido exitosamente.");
            closeAddModal();
            Get(); // Recarga la lista de inventario
          } else {
            alert("Error al añadir el artículo.");
          }
        })
        .catch(error => {
          console.error("Error en la adición:", error);
          alert("Error en la conexión.");
        });
    }

    // Funciones para modificar el artículo
    function editMaterial(id, material, initialStock, finalStock) {
      // Mostrar el modal
      document.getElementById("editModal").style.display = "block";

      // Llenar los campos del modal con los datos actuales
      document.getElementById("editId").value = id;
      document.getElementById("editItemName").value = material;
      document.getElementById("editInitialQuantity").value = initialStock;
      document.getElementById("editFinalQuantity").value = finalStock;
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
    }

    function updateRecord(event) {
      event.preventDefault();

      // Captura los valores de los campos del modal
      const id = document.getElementById("editId").value;
      const material = document.getElementById("editItemName").value;
      const initialStock = document.getElementById("editInitialQuantity").value;
      const finalStock = document.getElementById("editFinalQuantity").value;
      const date = new Date().toISOString(); // Fecha actual

      // Crea el objeto con los datos
      const updatedInventory = {
        InventoryID: id,
        MaterialID: id,
        InitialStock: parseInt(initialStock),
        FinalStock: parseInt(finalStock),
        Date: date,
        BatchNumber: material // Usa el nombre del material como número de lote, si aplica
      };

      // Realiza la solicitud PUT a la API
      fetch(`http://localhost:63152/api/Inventory/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(updatedInventory)
      })
        .then(response => {
          if (response.ok) {
            alert("Registro actualizado exitosamente.");
            closeModal();
            Get(); // Recarga la lista de inventario
          } else {
            alert("Error al actualizar el registro.");
          }
        })
        .catch(error => {
          console.error("Error en la actualización:", error);
          alert("Error en la conexión.");
        });
    }

    // Cerrar el modal cuando se hace clic en el fondo
    window.onclick = function (event) {
      if (event.target == document.getElementById("editModal")) {
        closeModal();
      }
    }
  </script>

</body>

</html>
