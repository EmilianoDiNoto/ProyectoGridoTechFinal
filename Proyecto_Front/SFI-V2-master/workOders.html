<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>WorkOrders</title>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/sweetalert2.css">
	<link rel="stylesheet" href="css/material.min.css">
	<link rel="stylesheet" href="css/material-design-iconic-font.min.css">
	<link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/stylesWO.css">

	<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
	<script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
	<script src="js/material.min.js"></script>
	<script src="js/sweetalert2.min.js"></script>
	<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
	<script src="js/main.js"></script>
</head>

<body>
	<div class=" nav-container">

		<!-- navLateral -->
		<section class="full-width navLateral">
			<div class="full-width navLateral-bg btn-menu"></div>
			<div class="full-width navLateral-body">
				<div class="full-width navLateral-body-logo text-center tittles">
					<i class="zmdi zmdi-close btn-menu"></i> Grido Tech Advance
				</div>
				<figure class="full-width navLateral-body-tittle-menu">
					<div>
						<img src="assets/img/Emi (sin Fondo).png" alt="Avatar" class="img-responsive">
					</div>
					<figcaption>
						<span>
							Emiliano Di Noto<br>
							<small>Administrador</small>
						</span>
					</figcaption>
				</figure>
				<nav class="full-width">
					<ul class="full-width list-unstyle menu-principal">
						<li class="full-width">
							<a href="home.html" class="full-width">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-view-dashboard"></i>
								</div>
								<div class="navLateral-body-cr">
									Inicio
								</div>
							</a>
						</li>
						<li class="full-width divider-menu-h"></li>
						<li class="full-width">
							<a href="production.html" class="full-width">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-washing-machine"></i>
								</div>
								<div class="navLateral-body-cr">
									Declarar Producción
								</div>
							</a>
						</li>
	
						<li class="full-width divider-menu-h"></li>
						<li class="full-width">
							<a href="workOders.html" class="full-width">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-washing-machine"></i>
								</div>
								<div class="navLateral-body-cr">
									Ordenes de Trabajo
								</div>
							</a>
						</li>
						<li class="full-width divider-menu-h"></li>
						<li class="full-width">
	
							<a href="#!" class="full-width btn-subMenu">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-case"></i>
								</div>
								<div class="navLateral-body-cr">
									Materiales
								</div>
								<span class="zmdi zmdi-chevron-left"></span>
							</a>
							<ul class="full-width menu-principal sub-menu-options">
								<li class="full-width">
									<a href="company.html" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-balance"></i>
										</div>
										<div class="navLateral-body-cr">
											Materiales
										</div>
									</a>
								</li>
								<li class="full-width">
									<a href="providers.html" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-truck"></i>
										</div>
										<div class="navLateral-body-cr">
											Materiales Descartados
										</div>
									</a>
								</li>
								<li class="full-width">
									<a href="payments.html" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-card"></i>
										</div>
										<div class="navLateral-body-cr">
											Materiales Retenidos
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li class="full-width divider-menu-h"></li>
						<li class="full-width">
							<a href="products.html" class="full-width">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-washing-machine"></i>
								</div>
								<div class="navLateral-body-cr">
									Productos
								</div>
							</a>
						</li>
						<li class="full-width divider-menu-h"></li>
						<li class="full-width">
							<a href="productStore.html" class="full-width">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-store"></i>
								</div>
								<div class="navLateral-body-cr">
									Almacen
								</div>
							</a>
						</li>
						<li class="full-width divider-menu-h"></li>
						<!-- <li class="full-width">
							<a href="sales.html" class="full-width">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-shopping-cart"></i>
								</div>
								<div class="navLateral-body-cr">
									Informes
								</div>
							</a>
						</li>
						<li class="full-width divider-menu-h"></li> -->
						<li class="full-width">
							<a href="#!" class="full-width btn-subMenu">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-face"></i>
								</div>
								<div class="navLateral-body-cr">
									Gestión de Usuarios
								</div>
								<span class="zmdi zmdi-chevron-left"></span>
							</a>
							<ul class="full-width menu-principal sub-menu-options">
								<li class="full-width">
									<a href="admin.html" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-account"></i>
										</div>
										<div class="navLateral-body-cr">
											Administradores
										</div>
									</a>
								</li>
								<li class="full-width">
									<a href="client.html" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-accounts"></i>
										</div>
										<div class="navLateral-body-cr">
											Usuarios
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li class="full-width">
							<a href="#!" class="full-width btn-subMenu">
								<div class="navLateral-body-cl">
									<i class="zmdi zmdi-wrench"></i>
								</div>
								<div class="navLateral-body-cr">
									Configuración
								</div>
								<span class="zmdi zmdi-chevron-left"></span>
							</a>
							<ul class="full-width menu-principal sub-menu-options">
								<li class="full-width">
									<a href="#!" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-widgets"></i>
										</div>
										<div class="navLateral-body-cr">
											Opción 1
										</div>
									</a>
								</li>
								<li class="full-width">
									<a href="#!" class="full-width">
										<div class="navLateral-body-cl">
											<i class="zmdi zmdi-widgets"></i>
										</div>
										<div class="navLateral-body-cr">
											Opción 2
										</div>
									</a>
								</li>
							</ul>
						</li>
					</ul>
				</nav>
			</div>
		</section>
		<!-- Notifications area -->
		<section class="full-width container-notifications">

			<div class="full-width container-notifications-bg btn-Notification"></div>
			<section class="NotificationArea">
				<div class="full-width text-center NotificationArea-title tittles">Notifications <i
						class="zmdi zmdi-close btn-Notification"></i></div>
				<a href="#" class="Notification" id="notifation-unread-1">
					<div class="Notification-icon"><i class="zmdi zmdi-accounts-alt bg-info"></i></div>
					<div class="Notification-text">
						<p>
							<i class="zmdi zmdi-circle"></i>
							<strong>New User Registration</strong>
							<br>
							<small>Just Now</small>
						</p>
					</div>
					<div class="mdl-tooltip mdl-tooltip--left" for="notifation-unread-1">Notification as UnRead
					</div>
				</a>
				<a href="#" class="Notification" id="notifation-read-1">
					<div class="Notification-icon"><i class="zmdi zmdi-cloud-download bg-primary"></i></div>
					<div class="Notification-text">
						<p>
							<i class="zmdi zmdi-circle-o"></i>
							<strong>New Updates</strong>
							<br>
							<small>30 Mins Ago</small>
						</p>
					</div>
					<div class="mdl-tooltip mdl-tooltip--left" for="notifation-read-1">Notification as Read</div>
				</a>
				<a href="#" class="Notification" id="notifation-unread-2">
					<div class="Notification-icon"><i class="zmdi zmdi-upload bg-success"></i></div>
					<div class="Notification-text">
						<p>
							<i class="zmdi zmdi-circle"></i>
							<strong>Archive uploaded</strong>
							<br>
							<small>31 Mins Ago</small>
						</p>
					</div>
					<div class="mdl-tooltip mdl-tooltip--left" for="notifation-unread-2">Notification as UnRead
					</div>
				</a>
				<a href="#" class="Notification" id="notifation-read-2">
					<div class="Notification-icon"><i class="zmdi zmdi-mail-send bg-danger"></i></div>
					<div class="Notification-text">
						<p>
							<i class="zmdi zmdi-circle-o"></i>
							<strong>New Mail</strong>
							<br>
							<small>37 Mins Ago</small>
						</p>
					</div>
					<div class="mdl-tooltip mdl-tooltip--left" for="notifation-read-2">Notification as Read</div>
				</a>
				<a href="#" class="Notification" id="notifation-read-3">
					<div class="Notification-icon"><i class="zmdi zmdi-folder bg-primary"></i></div>
					<div class="Notification-text">
						<p>
							<i class="zmdi zmdi-circle-o"></i>
							<strong>Folder delete</strong>
							<br>
							<small>1 hours Ago</small>
						</p>
					</div>
					<div class="mdl-tooltip mdl-tooltip--left" for="notifation-read-3">Notification as Read</div>
				</a>
			</section>

		</section>
		<!-- Barra de arriba -->
		<section class="full-width pageContent">
			<section class="full-width pageContent">
				<!-- navBar -->
				<div class="full-width navBar">
					<div class="full-width navBar-options">
						<i class="zmdi zmdi-swap btn-menu" id="btn-menu"></i>
						<div class="mdl-tooltip" for="btn-menu">Hide / Show MENU</div>
						<h5 style="text-align: center;">ORDENES DE TRABAJO</h5>

						<nav class="navBar-options-list">
							<ul class="list-unstyle">
								<li class="btn-Notification" id="notifications">
									<i class="zmdi zmdi-notifications"></i>
									<div class="mdl-tooltip" for="notifications">Notifications</div>
								</li>
								<li class="btn-exit" id="btn-exit">
									<i class="zmdi zmdi-power"></i>
									<div class="mdl-tooltip" for="btn-exit">LogOut</div>
								</li>
								<li class="text-condensedLight noLink"><small>Emiliano Di Noto</small></li>
								<li class="noLink">
									<figure>
										<img src="assets/img/Emi (sin Fondo).png" alt="Avatar" class="img-responsive">
									</figure>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</section>
		</section>
		<!-- Graficos -->
		<div class="content-container">
			<div style="text-align: left; margin-bottom: 100px; margin-top: 10px;">
				<span id="order-status"
					style="background-color: #1E90FF; color: white; padding: 10px 20px; border-radius: 5px; font-size: 18px;">
					Calculando el porcentaje...
				</span>

			</div>
			<div style="width: 20%; margin: 0 ; text-align: righ;">
				<canvas id="orderChart"></canvas>
			</div>
		</div>
		<!-- Tablas y filtros -->
		<div class="contenedor">

			<div class="table-container">
				<table>

					<thead>
			</div>
			<H5 style="text-align: center;">LISTAR ORDENES DE TRABAJO</H5>
			<div class="filters">

				<label for="filter-ot"></label>
				<input type="text" id="filter-ot" placeholder="Ingrese OT">

				<label for="filter-producto"></label>
				<input type="text" id="filter-producto" placeholder="Ingrese Producto">

				<label for="filter-fecha-desde">DESDE</label>
				<input type="date" id="filter-fecha-desde">

				<label for="filter-fecha-hasta">HASTA</label>
				<input type="date" id="filter-fecha-hasta">
			</div>
			<tr>
				<th><span class="las la-sort"></span>OT</th>
				<th><span class="las la-sort"></span>CODIGO</th>
				<th><span class="las la-sort"></span>PRODUCTO</th>
				<th><span class="las la-sort"></span>DEMANDA</th>
				<th><span class="las la-sort"></span>UM</th>
				<th><span class="las la-sort"></span>ESTADO</th>
				<th><span class="las la-sort"></span>FECHA ELABORACION</th>
			</tr>
			</thead>
			<tbody>
			</tbody>
			</table>
			<!-- Modal para mostrar los materiales -->
			<div id="materials-modal" class="modal">
				<div class="modal-content">
					<span class="close">&times;</span>
					<h3>NECESIDAD DE MATERIALES</h3>
					<table id="materials-table">
						<thead>
							<tr>
								<th>MATERIAL</th>
								<th>NECESIDAD</th>
								<th>UM</th>
								<th>CODIGO</th>
								<th>FECHA ENTREGA</th>
							</tr>
						</thead>
						<tbody>
							<!-- Los materiales aparecerán aquí -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<script>
		let orderChart;

		function formatDate(dateString) {
			const date = new Date(dateString);
			const day = String(date.getDate()).padStart(2, '0');
			const month = String(date.getMonth() + 1).padStart(2, '0');
			const year = date.getFullYear();

			return `${day}-${month}-${year}`;
		}

		function Get() {
			fetch("http://localhost:63152/api/WorkOrders")
				.then((response) => {
					if (!response.ok) throw new Error("Error al obtener las órdenes de trabajo");
					return response.json();
				})
				.then((data) => {
					const tbody = document.querySelector('tbody');
					tbody.innerHTML = ''; // Limpiar la tabla

					let completed = 0;
					let pending = 0;

					// Crear un objeto para contar órdenes por producto
					const productCounts = {};

					data.forEach((o) => {
						//Comparacion de realizadas/Pendientes
						if (o.ESTADO === "REALIZADA") completed++;
						else if (o.ESTADO === "PENDIENTE") pending++;

						const fechaElaboracion = formatDate(o.FECHAELABORACION);

						const _tr = `
							<tr class="order-row" data-ot="${o.OT}">
								<td data-label="OT">${o.OT}</td>
								<td data-label="CODIGO">${o.CODIGO}</td>
								<td data-label="PRODUCTO">${o.PRODUCTO}</td>
								<td data-label="DEMANDA">${o.DEMANDA}</td>
								<td data-label="UM">${o.UM}</td>
								<td data-label="ESTADO">${o.ESTADO}</td>
								<td data-label="FECHA ELABORACIÓN">${fechaElaboracion}</td>
								
							</tr>`;
						tbody.innerHTML += _tr;
					});

					updateOrderStatus(completed, pending);
					createChart(completed, pending);

					document.querySelectorAll('.order-row').forEach(row => {
						row.addEventListener('click', (e) => {
							const ot = e.currentTarget.dataset.ot;
							showMaterials(ot);
						});
					});
				})
				.catch((error) => {
					console.error("Error:", error);
				});
		}


		function updateOrderStatus(completed, pending) {
			const total = completed + pending;
			const percentage = total > 0 ? ((completed / total) * 100).toFixed(2) : 0;

			const orderStatus = document.getElementById("order-status");
			orderStatus.textContent = `Órdenes Realizadas: ${completed}, Pendientes: ${pending} (${percentage}% Completadas)`;
			orderStatus.style.backgroundColor = percentage === 100 ? "#4CAF50" : "#1E90FF";
		}

		function createChart(completed, pending) {
			const ctx = document.getElementById('orderChart').getContext('2d');

			if (orderChart) {
				orderChart.destroy();
			}

			orderChart = new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: ['Realizadas', 'Pendientes'],
					datasets: [{
						data: [completed, pending],
						backgroundColor: ['#4169E1', '#191970'],
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: {
							position: 'top'
						},
						tooltip: {
							callbacks: {
								label: function (tooltipItem) {
									const total = completed + pending;
									const value = tooltipItem.raw;
									const percentage = ((value / total) * 100).toFixed(2);
									return `${tooltipItem.label}: ${percentage}% (${value})`;
								}
							}
						}
					}
				}
			});
		}

		function showMaterials(ot) {
			fetch(`http://localhost:63152/api/WorkOrderMaterial/GetWorkOrderMaterials?ot=${ot}`)
				.then((response) => {
					if (!response.ok) throw new Error("Error al obtener los materiales");
					return response.json();
				})
				.then((data) => {
					const tbody = document.querySelector('#materials-table tbody');
					tbody.innerHTML = '';

					data.forEach((material) => {
						const fechaEntrega = formatDate(material.FECHAENTREGA);

						const _tr = `
							<tr>
								<td>${material.MATERIAL}</td>
								<td>${material.NECESIDAD}</td>
								<td>${material.UM}</td>
								<td>${material.CODIGO}</td>
								<td>${fechaEntrega}</td>
							</tr>`;
						tbody.innerHTML += _tr;
					});

					document.getElementById("materials-modal").style.display = "block";
				})
				.catch((error) => {
					console.error("Error:", error);
				});
		}

		const closeBtn = document.querySelector(".close");
		if (closeBtn) {
			closeBtn.addEventListener("click", () => {
				document.getElementById("materials-modal").style.display = "none";
			});
		}

		window.onclick = function (event) {
			const modal = document.getElementById("materials-modal");
			if (event.target === modal) {
				modal.style.display = "none";
			}
		};

		function applyFilters() {
			const otFilter = document.getElementById('filter-ot').value.toLowerCase();
			const productoFilter = document.getElementById('filter-producto').value.toLowerCase();
			const fechaDesde = document.getElementById('filter-fecha-desde').value;
			const fechaHasta = document.getElementById('filter-fecha-hasta').value;

			const rows = document.querySelectorAll('tbody tr');

			rows.forEach(row => {
				const ot = row.querySelector('[data-label="OT"]').textContent.toLowerCase();
				const producto = row.querySelector('[data-label="PRODUCTO"]').textContent.toLowerCase();
				const fecha = row.querySelector('[data-label="FECHA ELABORACIÓN"]').textContent;

				// Formatear la fecha de la fila para comparación
				const rowDate = new Date(fecha.split('-').reverse().join('-')); // Convertir DD-MM-YYYY a YYYY-MM-DD

				const matchesOt = ot.includes(otFilter);
				const matchesProducto = producto.includes(productoFilter);

				// Verificar si la fecha está en el rango
				const matchesFecha =
					(!fechaDesde || rowDate >= new Date(fechaDesde)) &&
					(!fechaHasta || rowDate <= new Date(fechaHasta));

				if (matchesOt && matchesProducto && matchesFecha) {
					row.style.display = ''; // Mostrar fila
				} else {
					row.style.display = 'none'; // Ocultar fila
				}
			});
		}

		// Asignar eventos a los filtros
		document.getElementById('filter-ot').addEventListener('input', applyFilters);
		document.getElementById('filter-producto').addEventListener('input', applyFilters);
		document.getElementById('filter-fecha-desde').addEventListener('change', applyFilters);
		document.getElementById('filter-fecha-hasta').addEventListener('change', applyFilters);

		Get();
	</script>
	</script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.canvasjs.com/canvasjs.min.js"> </script>

</body>

</html>