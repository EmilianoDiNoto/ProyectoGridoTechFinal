<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Inicio</title>
	<link rel="stylesheet" href="css/normalize.css">
	<link rel="stylesheet" href="css/sweetalert2.css">
	<link rel="stylesheet" href="css/material.min.css">
	<link rel="stylesheet" href="css/material-design-iconic-font.min.css">
	<link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/robot.css">

	<!-- Highcharts core -->
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<!-- Para gráficos circulares -->
	<script src="https://code.highcharts.com/modules/exporting.js"></script>
	<script src="https://code.highcharts.com/modules/export-data.js"></script>
	<script src="https://code.highcharts.com/modules/accessibility.js"></script>

	<!-- Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="js/jquery-1.11.2.min.js"><\/script>')</script>
	<script src="js/material.min.js"></script>
	<script src="js/sweetalert2.min.js"></script>
	<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>

	<script src="js/main.js"></script>
	<script src="js/menuControl.js"></script>
	<script src="js/robot.js"></script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

	<!-- BOOTSTRAP -->
	<link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

	<!-- DataTables CSS -->
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
	<link rel="stylesheet" type="text/css"
		href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

	<!-- DataTables JS -->
	<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>
	<script type="text/javascript"
		src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

	<!-- SWEETALERT -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<!-- PRUEBA-->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
		// Configuración para DataTables
		window.dataTablesLanguage = {
			"decimal": "",
			"emptyTable": "No hay datos disponibles",
			"info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
			"infoEmpty": "Mostrando 0 a 0 de 0 registros",
			"infoFiltered": "(filtrado de _MAX_ registros totales)",
			"infoPostFix": "",
			"thousands": ",",
			"lengthMenu": "Mostrar _MENU_ registros",
			"loadingRecords": "Cargando...",
			"processing": "Procesando...",
			"search": "Buscar:",
			"zeroRecords": "No se encontraron coincidencias",
			"paginate": {
				"first": "Primero",
				"last": "Último",
				"next": "Siguiente",
				"previous": "Anterior"
			}
		};
	</script>

	<script>
		// Fix para el error de SweetAlert - Ejecutar antes de otros scripts
		window.addEventListener('DOMContentLoaded', function () {
			if (typeof Swal !== 'undefined' && typeof swal !== 'undefined' && !swal.init) {
				swal.init = function () {
					return typeof Swal.isVisible === 'function' ? Swal.isVisible() : false;
				};
				console.log('SweetAlert polyfill aplicado');
			}
		}, { once: true });
	</script>


</head>

<body>

	<div class="wrapper">
		<!-- Sidebar -->
		<aside id="sidebar">
			<div class="d-flex">
				<button class="toggle-btn" type="button">
					<i class="lni lni-grid-alt"></i>
				</button>
				<div class="sidebar-logo">
					<a href="#">Grido Tech Advance</a>
				</div>
			</div>
			<ul class="sidebar-nav">
				<li class="sidebar-item">
					<a href="home.html" class="sidebar-link">
						<i class="zmdi zmdi-view-dashboard"></i>
						<span>Inicio</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="production1.html" class="sidebar-link">
						<i class="zmdi zmdi-washing-machine"></i>
						<span>Declarar Producción</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="productionTable.html" class="sidebar-link">
						<i class="zmdi zmdi-washing-machine"></i>
						<span>Producción Confirmada</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="workOders.html" class="sidebar-link">
						<i class="zmdi zmdi-assignment"></i>
						<span>Órdenes de Trabajo</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="productStore.html" class="sidebar-link">
						<i class="zmdi zmdi-assignment"></i>
						<span>Almacen</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="incidents.html" class="sidebar-link">
						<i class="zmdi zmdi-assignment"></i>
						<span>Incidencias</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="materials.html" class="sidebar-link">
						<i class="zmdi zmdi-assignment"></i>
						<span>Materiales</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="products.html" class="sidebar-link">
						<i class="zmdi zmdi-store"></i>
						<span>Productos</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="Users_Gestion.html" class="sidebar-link">
						<i class="zmdi zmdi-store"></i>
						<span>Gestión de Usuarios</span>
					</a>
				</li>
				<li class="sidebar-item">
					<a href="index.html" class="sidebar-link">
						<i class="zmdi zmdi-store"></i>
						<span>Cerrar Sesión</span>
					</a>
				</li>
			</ul>
		</aside>

		<div class="main">
			<div class="welcome-section md-4"
				style="display: flex; justify-content: space-between; align-items: center;">
				<h1>Bienvenido, Emiliano</h1>
				<div class="ice-cream-container" style="display: flex; gap: 10px;">
					<div class="ice-cream-item" data-product="PACK TORTA COOKIES AND CREAM - GRIDO">
						<img src="assets/img/Torta-cookies-and-cream.jpg" alt="Cookie">

					</div>
					<div class="ice-cream-item" data-product="PACK TORTA COOKIES AND MOUSSE - GRIDO">
						<img src="assets/img/Torta-cookies-mousse.jpg" alt="Crema">

					</div>
					<div class="ice-cream-item" data-product="PACK TORTA GRIDO CON RELLENO - GRIDO">
						<img src="assets/img/Torta-Grido360X360.jpg" alt="Chocolate">

					</div>
				</div>
			</div>
			<br>
			<!-- Contadores superiores -->
			<div class="row mb-4">
				<div class="col-md-3">
					<div class="counter-card">
						<h3>TOTAL INVENTARIO VALORIZADO</h3>
						<p class="counter-value text-primary" id="inventario-valorizado">$0,00</p>
					</div>
				</div>
				<div class="col-md-3">
					<div class="counter-card">
						<h3>TOTAL DE DESVÍO PRODUCCIÓN</h3>
						<p class="counter-value text-danger" id="desvio-total">$0,00</p>
					</div>
				</div>
				<!-- Actualiza el contador de Stock Final con este código -->
				<div class="col-md-3">
					<div class="counter-card counter-clickable" id="stock-final-counter">
						<h3>STOCK FINAL</h3>
						<div class="counter-icon"><i class="zmdi zmdi-search"></i></div>
						<p class="counter-value text-info" id="stock-final-count"></p>
					</div>
				</div>
				<div class="col-md-3">
					<div class="counter-card">
						<h3>PEDIDOS PENDIENTES</h3>
						<p class="counter-value text-warning">0</p>
					</div>
				</div>
			</div>

			<!-- Contadores superiores -->

			<!-- Nuevo layout para la sección de gráficos -->
			<div class="row">
				<!-- Balance de Masas General (ocupa 8/12 columnas en desktop) -->
				<div class="col-12 col-lg-8 mb-4">
					<div class="chart-container chart-container-large">
						<h3 class="chart-title">Balance de Masas Total</h3>
						<div id="balance-highchart-container" class="highchart-wrapper"></div>
						<button id="balance-consultar-btn" class="btn btn-consultar" data-bs-toggle="modal"
							data-bs-target="#balanceModal">
							Consultar
						</button>
					</div>

					<!-- Producción por Temporada -->
					<div class="chart-container chart-container-medium">
						<h3 class="chart-title">Producción por Temporada</h3>
						<div id="produccion-temporada-container" class="highchart-wrapper"></div>
					</div>
				</div>

				<!-- Columna derecha (ocupa 4/12 columnas en desktop) -->
				<div class="col-12 col-lg-4 mb-4">
					<!-- Última Producción - versión modificada sin gráfico de torta -->
					<div class="chart-container chart-container-small">
						<h3 class="chart-title">Última Producción</h3>

						<!-- Contenedor de tarjetas de métricas -->
						<div class="metrics-container"
							style="display: flex; justify-content: space-between; padding: 15px 0; width: 100%;">

						</div>

						<!-- Mantener el botón de consultar -->
						<button class="btn btn-consultar" data-bs-toggle="modal" data-bs-target="#productionModal"
							style="margin-top: 15px;">
							Consultar
						</button>
					</div>

					<!-- Órdenes de Trabajo -->
					<div class="chart-container chart-container-small">
						<h3 class="chart-title">Órdenes de Trabajo</h3>
						<div id="ordenes-trabajo-container" class="highchart-wrapper"></div>
					</div>
				</div>
			</div>

			<!-- Nueva fila para Producción Anual (ocupa 12/12 columnas) -->
			<div class="row">
				<div class="col-12 mb-4">
					<div class="chart-container chart-container-medium">
						<h3 class="chart-title">Producción Anual</h3>
						<div id="produccion-anual-container" class="highchart-wrapper"></div>
					</div>
				</div>
			</div>

			<div id="container" style="width: 100%; height: 400px;"></div>


			<!-- Modal Producción -->
			<div class="modal fade" id="productionModal" tabindex="-1" aria-labelledby="productionModalLabel"
				aria-hidden="true">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="productionModalLabel">Última Producción</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="row">
								<div class="col-md-6">
									<h6>Producción OT 4</h6>
									<table id="productionTable" class="display nowrap" style="width:100%">
										<thead>
											<tr>
												<th>FECHA</th>
												<th>TURNO</th>
												<th>RESPONSABLE</th>
												<th>OT</th>
												<th>PRODUCTO</th>
												<th>PRODUCIDO</th>
												<th>PERFORMANCE</th>
											</tr>
										</thead>
									</table>
								</div>
								<div class="col-md-6">
									<h6>Balance de Masas OT 4</h6>
									<table id="theoricalTableInProduction" class="display nowrap" style="width:100%">
										<thead>
											<tr>
												<th>Material</th>
												<th>Teórico</th>
												<th>Real</th>
												<th>Desvío</th>
											</tr>
										</thead>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal Balance de Masas -->
			<div class="modal fade" id="balanceModal" tabindex="-1" aria-labelledby="balanceModalLabel"
				aria-hidden="true">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="balanceModalLabel">BALANCE DE MASAS TOTAL</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<!-- Modificar la tabla en el modal Balance de Masas (paste.txt, alrededor de línea 333) -->
							<table id="consolidadoBMTable" class="display nowrap" style="width:100%">
								<thead>
									<tr>
										<th>Material</th>
										<th>Consumo Teórico</th>
										<th>Consumo Real</th>
										<th>Desvío</th>
										<th>Valor</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal Stock Final -->
			<div class="modal fade" id="stockModal" tabindex="-1" aria-labelledby="stockModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-xl">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="stockModalLabel">Stock Final</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<table id="stockTable" class="display nowrap" style="width:100%">
								<thead>
									<tr>
										<th>FECHA</th>
										<th>TURNO</th>
										<th>RESPONSABLE</th>
										<th>OT</th>
										<th>MATERIAL</th>
										<th>CANTIDAD</th>
										<th>PROVEEDOR</th>
										<th>LOTE</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>


			<!-- Chatbot Container -->
			<div id="robot-grido-container" class="robot-grido-container">
				<div class="robot-header">
					<h3>
						<img src="assets/img/bot.png" alt="Robot Grido" class="robot-grido-icon">
						Robot Grido
					</h3>
					<div class="header-buttons">
						<button id="clear-chat" class="clear-chat-btn" title="Limpiar conversación">
							<i class="zmdi zmdi-brush"></i>
						</button>
						<button id="expand-chat" class="expand-chat-btn" title="Pantalla completa">
							<i class="zmdi zmdi-fullscreen"></i>
						</button>
						<button id="toggle-chat" class="toggle-chat-btn" title="Minimizar">
							<i class="zmdi zmdi-chevron-down"></i>
						</button>
					</div>
				</div>
				<div class="chat-content">
					<div class="chat-messages" id="chat-messages">
						<div class="message bot-message">
							<div class="message-content">
								<p>Hola, soy Robot Grido. ¿En qué puedo ayudarte hoy?</p>
							</div>
						</div>
						<!-- Aquí se insertan las tarjetas de opciones -->
						<div id="option-cards" class="option-cards">
							<div class="option-card" data-option="ordenes">
								<i class="zmdi zmdi-assignment"></i>
								<span>Órdenes de Trabajo</span>
							</div>
							<div class="option-card" data-option="produccion">
								<i class="zmdi zmdi-washing-machine"></i>
								<span>Producción de tortas</span>
							</div>
							<div class="option-card" data-option="balances">
								<i class="zmdi zmdi-chart"></i>
								<span>Balances de masas</span>
							</div>
							<div class="option-card" data-option="incidentes">
								<i class="zmdi zmdi-alert-triangle"></i>
								<span>Incidentes</span>
							</div>
							<div class="option-card" data-option="solicitudes">
								<i class="zmdi zmdi-file-text"></i>
								<span>Solicitudes</span>
							</div>
						</div>
					</div>
					<div class="chat-input-container">
						<input type="text" id="user-input" class="chat-input" placeholder="Escribe tu pregunta aquí...">
						<button id="send-message" class="send-button">
							<i class="zmdi zmdi-mail-send"></i>
						</button>
					</div>
				</div>
			</div>

			<!-- Overlay para el modo de pantalla completa -->
			<div id="chat-overlay" class="chat-overlay"></div>

		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
		crossorigin="anonymous"></script>
	<script>
		// Evitar duplicación de botones
		window.addEventListener('resize', function () {
			// Verificar si hay múltiples botones en el contenedor de Balance de Masas
			const container = document.querySelector('.chart-container-large');
			if (container) {
				const buttons = container.querySelectorAll('.btn-consultar');
				// Si hay más de un botón, eliminar los adicionales
				if (buttons.length > 1) {
					for (let i = 1; i < buttons.length; i++) {
						buttons[i].remove();
					}
				}
			}
		});
	</script>

	<script>
		// Script para actualizar el contador de pedidos pendientes
		document.addEventListener('DOMContentLoaded', function () {
			console.log("Iniciando contador de pedidos pendientes...");

			// Función para actualizar el contador
			async function actualizarPedidosPendientes() {
				try {
					console.log("Consultando API de solicitudes...");

					// Realizar la petición a la API
					const response = await fetch('http://localhost:63152/api/SolicitudMaterialRepository/GetAllSolicitudes');

					// Verificar si la respuesta es correcta
					if (!response.ok) {
						throw new Error(`Error en la petición: ${response.status}`);
					}

					// Convertir la respuesta a JSON
					const solicitudes = await response.json();
					console.log("Solicitudes recibidas:", solicitudes.length);
					console.log("Muestra de datos:", solicitudes.length > 0 ? solicitudes[0] : "No hay datos");

					// Filtrar solo las solicitudes con estado "SOLICITADO" (ajustado a los nombres de propiedades correctos)
					const pedidosPendientes = solicitudes.filter(solicitud =>
						solicitud.Estado && solicitud.Estado.trim().toUpperCase() === "SOLICITADO"
					);
					console.log("Pedidos pendientes filtrados:", pedidosPendientes.length);

					// Buscar el contador de pedidos pendientes
					const contadores = document.querySelectorAll('.counter-card');
					let contadorElement = null;

					// Buscar la tarjeta que contiene "PEDIDOS PENDIENTES"
					contadores.forEach(contador => {
						const titulo = contador.querySelector('h3');
						if (titulo && titulo.textContent.trim() === "PEDIDOS PENDIENTES") {
							contadorElement = contador.querySelector('.counter-value');
						}
					});

					if (!contadorElement) {
						console.error("No se pudo encontrar el contador de pedidos pendientes.");
						return;
					}

					// Actualizar el contador
					contadorElement.textContent = pedidosPendientes.length;
					console.log("Contador actualizado:", pedidosPendientes.length);

					// Cambiar el color según la cantidad
					if (pedidosPendientes.length > 5) {
						contadorElement.className = 'counter-value text-danger';
					} else if (pedidosPendientes.length > 0) {
						contadorElement.className = 'counter-value text-warning';
					} else {
						contadorElement.className = 'counter-value text-success';
					}

					// Hacer la tarjeta clickeable
					const tarjeta = contadorElement.closest('.counter-card');
					if (tarjeta && !tarjeta.hasAttribute('data-clickeable')) {
						tarjeta.style.cursor = 'pointer';
						tarjeta.setAttribute('data-clickeable', 'true');
						tarjeta.addEventListener('click', () => mostrarDetallesPedidos(pedidosPendientes));
					}

				} catch (error) {
					console.error('Error al actualizar pedidos pendientes:', error);
				}
			}

			// Función para mostrar detalles de pedidos solo cuando se hace clic en la tarjeta
			function mostrarDetallesPedidos(pedidos) {
				if (!pedidos || pedidos.length === 0) {
					return; // No mostrar nada si no hay pedidos pendientes
				}

				// Crear tabla con los detalles
				let tablaPedidos = `
				<div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
					<table class="table table-striped table-hover">
						<thead class="thead-dark" style="background-color: #0e2238; color: white;">
							<tr>
								<th>ID</th>
								<th>Fecha</th>
								<th>Estado</th>
								<th>Usuario</th>
							</tr>
						</thead>
						<tbody>
			`;

				// Añadir cada pedido a la tabla con los nombres de propiedades correctos
				pedidos.forEach(pedido => {
					// Formatear la fecha si existe
					const fecha = pedido.FechaSolicitud ? new Date(pedido.FechaSolicitud).toLocaleDateString() : 'N/A';

					tablaPedidos += `
					<tr>
						<td>${pedido.SolicitudID || ''}</td>
						<td>${fecha}</td>
						<td>${pedido.Estado || ''}</td>
						<td>${pedido.Usuario || 'Sin asignar'}</td>
					</tr>
				`;
				});

				// Cerrar la tabla
				tablaPedidos += `
						</tbody>
					</table>
				</div>
			`;

				// Mostrar la tabla en un modal de SweetAlert2 (solo cuando se hace clic)
				Swal.fire({
					title: 'Pedidos Pendientes',
					html: tablaPedidos,
					width: '80%',
					showCloseButton: true,
					showConfirmButton: false,
					focusConfirm: false
				});
			}

			// Ejecutar inmediatamente
			actualizarPedidosPendientes();

			// Actualizar cada 5 minutos
			setInterval(actualizarPedidosPendientes, 5 * 60 * 1000);
		});
	</script>
	<script src="js/incidents.js"></script>
	<script src="js/production1.js"></script>
</body>

</html>